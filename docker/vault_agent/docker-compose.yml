services:
  vault_agent:
    build:
      context: ../..
      dockerfile: docker/vault_agent/Dockerfile
    image: custom_vault_agent:latest
    container_name: vault_agent
    cap_add:
      - IPC_LOCK  # Allow Vault to lock memory for production-like setups
    env_file:
      - .env
    environment:
      SKIP_SETCAP: false
      VAULT_ADDR: ${VAULT_ADDR}
      ENVIRONMENT: ${ENVIRONMENT}
      SSH_MANAGER_ROLE_NAME: ${SSH_MANAGER_ROLE_NAME:-ssh_manager_role}
    networks:
      - ansible_network
    volumes:
      - vault_file:/vault/file
      - vault_logs:/vault/logs
      - ./scripts:/vault/scripts
      - ./secrets:/vault/secrets
      - ./config:/vault/config:ro
      - ../vault_server/auth/${SSH_MANAGER_ROLE_NAME}:/vault/auth/${SSH_MANAGER_ROLE_NAME}:ro
    entrypoint: [ "sh", "/vault/scripts/agent_startup.sh" ]
    # TODO: Run the service with vault user instead of the root user
    # 100:1000 is the UID:GID of the vault user in the container.
    # user: "100:1000"  # Ensure container runs as 'vault' user
    healthcheck:
      test:
        [
          "CMD", "sh", "-c",
          "pgrep -f 'vault agent' > /dev/null || exit 1"
        ]
      interval: 30s
      retries: 3
      timeout: 10s
      start_period: 10s

volumes:
  vault_file:
  vault_logs:

networks:
  ansible_network:
    driver: bridge
