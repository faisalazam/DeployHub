Vagrant.configure("2") do |config|
  config.vm.box = "StefanScherer/windows_2019"
  config.vm.box_version = "2021.05.15"

  # Increase WinRM timeout to allow VM more time to boot
  config.vm.boot_timeout = 600

  # Forward RDP and WinRM ports
  config.vm.network "forwarded_port", guest: 3389, host: 3390
  config.vm.network "forwarded_port", guest: 5985, host: 55985
  config.vm.network "forwarded_port", guest: 5986, host: 55986

  # Provision WinRM configuration
  config.vm.provision "shell", inline: <<-SHELL
    powershell -Command "Enable-PSRemoting -Force"
    powershell -Command "Set-Service -Name WinRM -StartupType Automatic"
    powershell -Command "Start-Service -Name WinRM"
    powershell -Command "Set-Item WSMan:\\localhost\\Client\\TrustedHosts -Value '*' -Force"
    powershell -Command "New-NetFirewallRule -Name 'Allow WinRM HTTP' -Protocol TCP -LocalPort 5985 -Action Allow"
    powershell -Command "New-NetFirewallRule -Name 'Allow WinRM HTTPS' -Protocol TCP -LocalPort 5986 -Action Allow"
  SHELL
end
